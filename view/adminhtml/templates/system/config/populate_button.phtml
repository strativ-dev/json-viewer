<?php
/** @var \Strativ\JsonViewer\Block\Adminhtml\System\Config\PopulateButton $block */
?>
<div id="populate_tables_container">
    <?= $block->getButtonHtml() ?>
</div>

<script type="text/javascript">
require([
    'jquery',
    'Magento_Ui/js/modal/alert'
], function($, alert) {
    // Saved table columns data
    var savedTableColumnsData = <?= $block->getSavedTableColumns() ?>;
    
    // populate tables
    window.populateTableColumns = function() {
        var selectedTables = $('#strativ_jsonviewer_general_selected_tables').val();
        
        if (!selectedTables || selectedTables.length === 0) {
            alert({
                title: 'No Tables Selected',
                content: 'Please select at least one table from the "Select Database Tables" field.'
            });
            return;
        }

        var tableColumnsContainer = $('#strativ_jsonviewer_general_table_columns');
        var addButton = tableColumnsContainer.find('button.action-add');
        
        tableColumnsContainer.find('tbody tr').each(function() {
            if (!$(this).hasClass('_template')) {
                $(this).find('button.action-delete').trigger('click');
            }
        });

        for (var i = 0; i < selectedTables.length; i++) {
            addButton.trigger('click');
        }

        setTimeout(function() {
            var rows = tableColumnsContainer.find('tbody tr:not(._template)');
            selectedTables.forEach(function(tableName, index) {
                $(rows[index]).find('select[name*="[table_name]"]').val(tableName).trigger('change');
            });
            
            alert({
                title: 'Success',
                content: selectedTables.length + ' table(s) have been populated. Please configure the columns for each table.'
            });
        }, 200);
    };

    // populate table columns
    function populateColumnOptions(tableNameSelect, savedColumns) {
        var selectedTable = $(tableNameSelect).val();
        var row = $(tableNameSelect).closest('tr');
        var columnMultiselect = row.find('select[name*="[columns]"]');
        
        if (!columnMultiselect.length || !selectedTable) {
            return;
        }

        var allColumnsData = columnMultiselect.attr('data-all-columns');
        if (!allColumnsData) {
            return;
        }

        try {
            var allColumns = JSON.parse(allColumnsData);
            var tableColumns = allColumns[selectedTable] || [];
            
            // Use saved columns if provided, otherwise get current values
            var selectedValues = savedColumns || columnMultiselect.val() || [];
            if (!Array.isArray(selectedValues)) {
                selectedValues = selectedValues ? [selectedValues] : [];
            }
            
            columnMultiselect.empty();
            
            tableColumns.forEach(function(column) {
                var option = $('<option></option>')
                    .attr('value', column.value)
                    .text(column.label);
                
                if (selectedValues.indexOf(column.value) !== -1) {
                    option.attr('selected', 'selected');
                }
                
                columnMultiselect.append(option);
            });
        } catch (e) {
            console.error('Error parsing columns data:', e);
        }
    }

    $(document).on('change', 'select[name*="[table_name]"]', function() {
        populateColumnOptions(this);
    });

    // Initialize existing rows on page load
    setTimeout(function() {
        $('#strativ_jsonviewer_general_table_columns tbody tr:not(._template)').each(function() {
            var tableNameSelect = $(this).find('select[name*="[table_name]"]');
            var rowId = $(this).attr('id');
            
            if (tableNameSelect.length && tableNameSelect.val()) {
                // Find saved columns for this row
                var savedColumns = null;
                if (rowId && savedTableColumnsData[rowId]) {
                    savedColumns = savedTableColumnsData[rowId].columns;
                }
                
                populateColumnOptions(tableNameSelect, savedColumns);
            }
        });
    }, 500);
});
</script>